<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste - Sistema de Aprova√ß√£o de Usu√°rios</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .notification { transition: all 0.3s ease; }
        .fade-in { animation: fadeIn 0.5s ease-in; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body class="bg-gray-100">
    <div class="container mx-auto px-4 py-8">
        <h1 class="text-3xl font-bold text-gray-800 mb-8">üîê Teste - Sistema de Aprova√ß√£o de Usu√°rios</h1>
        
        <!-- Status do Sistema -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-8">
            <h2 class="text-xl font-semibold mb-4">üìä Status do Sistema</h2>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div class="bg-blue-50 p-4 rounded">
                    <div class="text-blue-600 font-semibold">Usu√°rios Ativos</div>
                    <div id="activeUsersCount" class="text-2xl font-bold">0</div>
                </div>
                <div class="bg-yellow-50 p-4 rounded">
                    <div class="text-yellow-600 font-semibold">Pendentes Aprova√ß√£o</div>
                    <div id="pendingUsersCount" class="text-2xl font-bold">0</div>
                </div>
                <div class="bg-green-50 p-4 rounded">
                    <div class="text-green-600 font-semibold">Emails Enviados</div>
                    <div id="emailsSentCount" class="text-2xl font-bold">0</div>
                </div>
                <div class="bg-red-50 p-4 rounded">
                    <div class="text-red-600 font-semibold">Cadastros Rejeitados</div>
                    <div id="rejectedUsersCount" class="text-2xl font-bold">0</div>
                </div>
            </div>
        </div>

        <!-- Simulador de Cadastro -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-8">
            <h2 class="text-xl font-semibold mb-4">üìù Simulador de Cadastro</h2>
            
            <form id="testRegistrationForm" class="space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Nome Completo:</label>
                        <input type="text" id="testNome" class="w-full p-3 border rounded" 
                               placeholder="Ex: Jo√£o Silva" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Email:</label>
                        <input type="email" id="testEmail" class="w-full p-3 border rounded" 
                               placeholder="joao@empresa.com" required>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Tipo de Usu√°rio:</label>
                        <select id="testTipo" class="w-full p-3 border rounded" required>
                            <option value="administrador">Administrador</option>
                            <option value="colaborador">Colaborador</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Senha:</label>
                        <input type="password" id="testSenha" class="w-full p-3 border rounded" 
                               placeholder="M√≠nimo 6 caracteres" required>
                    </div>
                </div>

                <div class="flex gap-4">
                    <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded">
                        <i class="fas fa-user-plus mr-2"></i>Simular Cadastro
                    </button>
                    <button type="button" onclick="generateRandomUser()" class="bg-gray-600 hover:bg-gray-700 text-white px-6 py-3 rounded">
                        <i class="fas fa-random mr-2"></i>Gerar Usu√°rio Aleat√≥rio
                    </button>
                </div>
            </form>
        </div>

        <!-- Lista de Usu√°rios Pendentes -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-8">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-semibold">‚è≥ Usu√°rios Pendentes de Aprova√ß√£o</h2>
                <button onclick="refreshAll()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded">
                    <i class="fas fa-sync-alt mr-2"></i>Atualizar
                </button>
            </div>
            <div id="pendingUsersList" class="space-y-4">
                <p class="text-gray-500">Nenhum usu√°rio pendente</p>
            </div>
        </div>

        <!-- Lista de Usu√°rios Ativos -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-8">
            <h2 class="text-xl font-semibold mb-4">üë• Usu√°rios Aprovados</h2>
            <div id="activeUsersList" class="space-y-4">
                <p class="text-gray-500">Nenhum usu√°rio ativo</p>
            </div>
        </div>

        <!-- Log de Emails -->
        <div class="bg-white rounded-lg shadow-md p-6">
            <h2 class="text-xl font-semibold mb-4">üìß Log de Emails Enviados</h2>
            <div id="emailLogsList" class="space-y-2">
                <p class="text-gray-500">Nenhum email enviado</p>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="js/storage.js"></script>
    <script src="js/zorix-storage.js"></script>
    <script src="js/api.js"></script>
    <script src="js/auth.js"></script>

    <script>
        // Dados de teste para gerar usu√°rios aleat√≥rios
        const nomes = ['Ana Silva', 'Carlos Santos', 'Maria Oliveira', 'Jo√£o Pereira', 'Fernanda Costa', 'Pedro Almeida'];
        const empresas = ['techsolar', 'energiaplus', 'solarbrasil', 'renovavel', 'sustentavel', 'ecoenergia'];

        let testAuth = null;

        // Inicializar sistema de teste
        async function initTest() {
            console.log('üöÄ Inicializando teste do sistema de aprova√ß√£o...');
            
            try {
                // Aguardar carregamento dos sistemas
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                // Criar inst√¢ncia de autentica√ß√£o para teste
                testAuth = new Auth();
                
                // Atualizar contadores
                updateCounts();
                
                // Carregar listas
                loadPendingUsers();
                loadActiveUsers();
                loadEmailLogs();
                
                console.log('‚úÖ Sistema de teste inicializado com sucesso');
            } catch (error) {
                console.error('‚ùå Erro ao inicializar teste:', error);
                showNotification('Erro ao inicializar sistema de teste', 'error');
            }
        }

        // Manipular formul√°rio de cadastro de teste
        document.getElementById('testRegistrationForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const nome = document.getElementById('testNome').value.trim();
            const email = document.getElementById('testEmail').value.trim();
            const tipo = document.getElementById('testTipo').value;
            const senha = document.getElementById('testSenha').value;
            
            if (!nome || !email || !tipo || !senha) {
                showNotification('Todos os campos s√£o obrigat√≥rios', 'error');
                return;
            }
            
            if (senha.length < 6) {
                showNotification('A senha deve ter pelo menos 6 caracteres', 'error');
                return;
            }
            
            try {
                console.log('üß™ Simulando cadastro:', { nome, email, tipo });
                const result = await testAuth.register(nome, email, tipo, senha);
                
                if (result && result.pendente) {
                    showNotification(`Cadastro de ${nome} aguardando aprova√ß√£o!`, 'warning');
                    
                    // Limpar formul√°rio
                    this.reset();
                    
                    // Atualizar listas
                    refreshAll();
                } else {
                    showNotification('Erro: Cadastro deveria estar pendente', 'error');
                }
            } catch (error) {
                console.error('‚ùå Erro no cadastro de teste:', error);
                showNotification(`Erro no cadastro: ${error.message}`, 'error');
            }
        });

        function generateRandomUser() {
            const nome = nomes[Math.floor(Math.random() * nomes.length)];
            const empresa = empresas[Math.floor(Math.random() * empresas.length)];
            const numero = Math.floor(Math.random() * 99) + 1;
            const email = `${nome.toLowerCase().replace(' ', '.')}@${empresa}.com.br`;
            
            document.getElementById('testNome').value = nome;
            document.getElementById('testEmail').value = email;
            document.getElementById('testTipo').value = Math.random() > 0.5 ? 'administrador' : 'colaborador';
            document.getElementById('testSenha').value = 'teste123';
        }

        function updateCounts() {
            try {
                // Usu√°rios pendentes
                const pendingUsers = JSON.parse(localStorage.getItem('zorix_usuarios_pendentes') || '[]');
                document.getElementById('pendingUsersCount').textContent = pendingUsers.length;

                // Usu√°rios ativos (do sistema principal)
                const activeUsers = JSON.parse(localStorage.getItem('solarcrm_usuarios') || '[]');
                document.getElementById('activeUsersCount').textContent = activeUsers.length;

                // Emails enviados
                const emailLogs = JSON.parse(localStorage.getItem('zorix_email_logs') || '[]');
                document.getElementById('emailsSentCount').textContent = emailLogs.length;

                // Usu√°rios rejeitados
                const rejectionLogs = JSON.parse(localStorage.getItem('zorix_rejection_logs') || '[]');
                document.getElementById('rejectedUsersCount').textContent = rejectionLogs.length;

            } catch (error) {
                console.error('‚ùå Erro ao atualizar contadores:', error);
            }
        }

        function loadPendingUsers() {
            try {
                const pendingUsers = JSON.parse(localStorage.getItem('zorix_usuarios_pendentes') || '[]');
                const container = document.getElementById('pendingUsersList');
                
                if (pendingUsers.length === 0) {
                    container.innerHTML = '<p class="text-gray-500">Nenhum usu√°rio pendente</p>';
                    return;
                }

                container.innerHTML = pendingUsers.map(user => `
                    <div class="border border-yellow-200 rounded-lg p-4 bg-yellow-50">
                        <div class="flex items-start justify-between">
                            <div class="flex items-start space-x-4">
                                <div class="w-12 h-12 bg-yellow-200 rounded-full flex items-center justify-center">
                                    <i class="fas fa-user text-yellow-600"></i>
                                </div>
                                <div>
                                    <h4 class="font-semibold text-gray-900">${user.nome}</h4>
                                    <p class="text-sm text-gray-600">üìß ${user.email}</p>
                                    <p class="text-sm text-gray-600">üè¢ ${user.tipo}</p>
                                    <p class="text-xs text-gray-500">‚è∞ ${new Date(user.data_cadastro).toLocaleString('pt-BR')}</p>
                                    <p class="text-xs text-gray-400">üÜî ${user.id}</p>
                                </div>
                            </div>
                            <div class="flex space-x-2">
                                <button onclick="approveUser('${user.id}', '${user.nome}')" 
                                    class="bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded text-sm">
                                    <i class="fas fa-check mr-1"></i>Aprovar
                                </button>
                                <button onclick="rejectUser('${user.id}', '${user.nome}')" 
                                    class="bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded text-sm">
                                    <i class="fas fa-times mr-1"></i>Rejeitar
                                </button>
                            </div>
                        </div>
                    </div>
                `).join('');

            } catch (error) {
                console.error('‚ùå Erro ao carregar usu√°rios pendentes:', error);
            }
        }

        function loadActiveUsers() {
            try {
                const activeUsers = JSON.parse(localStorage.getItem('solarcrm_usuarios') || '[]');
                const container = document.getElementById('activeUsersList');
                
                if (activeUsers.length === 0) {
                    container.innerHTML = '<p class="text-gray-500">Nenhum usu√°rio ativo</p>';
                    return;
                }

                container.innerHTML = activeUsers.map(user => `
                    <div class="border border-green-200 rounded-lg p-4 bg-green-50">
                        <div class="flex items-center space-x-4">
                            <div class="w-12 h-12 bg-green-200 rounded-full flex items-center justify-center">
                                <i class="fas fa-user-check text-green-600"></i>
                            </div>
                            <div class="flex-1">
                                <h4 class="font-semibold text-gray-900">${user.nome}</h4>
                                <p class="text-sm text-gray-600">üìß ${user.email}</p>
                                <p class="text-sm text-gray-600">üè¢ ${user.tipo}</p>
                                <p class="text-xs text-gray-500">
                                    ‚úÖ Ativo ‚Ä¢ 
                                    üìÖ ${user.data_aprovacao ? new Date(user.data_aprovacao).toLocaleString('pt-BR') : 'N/A'}
                                </p>
                            </div>
                            <div class="text-right">
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                    Aprovado
                                </span>
                            </div>
                        </div>
                    </div>
                `).join('');

            } catch (error) {
                console.error('‚ùå Erro ao carregar usu√°rios ativos:', error);
            }
        }

        function loadEmailLogs() {
            try {
                const emailLogs = JSON.parse(localStorage.getItem('zorix_email_logs') || '[]');
                const container = document.getElementById('emailLogsList');
                
                if (emailLogs.length === 0) {
                    container.innerHTML = '<p class="text-gray-500">Nenhum email enviado</p>';
                    return;
                }

                // Mostrar apenas os 10 mais recentes
                const recentLogs = emailLogs.slice(-10).reverse();

                container.innerHTML = recentLogs.map(log => `
                    <div class="border-l-4 ${getEmailTypeColor(log.type)} p-3 bg-gray-50 rounded">
                        <div class="flex items-center justify-between">
                            <div>
                                <span class="font-medium">${getEmailTypeText(log.type)}</span>
                                ${log.userData ? ` - ${log.userData.nome}` : ` - ${log.recipient}`}
                            </div>
                            <div class="text-xs text-gray-500">
                                ${new Date(log.timestamp).toLocaleString('pt-BR')}
                            </div>
                        </div>
                        <div class="text-sm text-gray-600 mt-1">
                            üìß Destinat√°rio: ${log.recipient || 'tittaneoenergias@gmail.com'}
                        </div>
                    </div>
                `).join('');

            } catch (error) {
                console.error('‚ùå Erro ao carregar logs de email:', error);
            }
        }

        function getEmailTypeColor(type) {
            switch (type) {
                case 'novo_cadastro': return 'border-blue-400';
                case 'aprovacao': return 'border-green-400';
                case 'rejeicao': return 'border-red-400';
                default: return 'border-gray-400';
            }
        }

        function getEmailTypeText(type) {
            switch (type) {
                case 'novo_cadastro': return 'üîî Novo Cadastro';
                case 'aprovacao': return '‚úÖ Aprova√ß√£o';
                case 'rejeicao': return '‚ùå Rejei√ß√£o';
                default: return 'üìß Email';
            }
        }

        async function approveUser(userId, userName) {
            if (!confirm(`Aprovar cadastro de "${userName}"?`)) return;
            
            try {
                await testAuth.approvePendingUser(userId);
                showNotification(`Usu√°rio ${userName} aprovado!`, 'success');
                refreshAll();
            } catch (error) {
                console.error('‚ùå Erro ao aprovar:', error);
                showNotification(`Erro ao aprovar: ${error.message}`, 'error');
            }
        }

        async function rejectUser(userId, userName) {
            const reason = prompt(`Motivo da rejei√ß√£o para "${userName}":`);
            if (reason === null) return;
            
            try {
                await testAuth.rejectPendingUser(userId, reason);
                showNotification(`Cadastro de ${userName} rejeitado`, 'warning');
                refreshAll();
            } catch (error) {
                console.error('‚ùå Erro ao rejeitar:', error);
                showNotification(`Erro ao rejeitar: ${error.message}`, 'error');
            }
        }

        function refreshAll() {
            updateCounts();
            loadPendingUsers();
            loadActiveUsers();
            loadEmailLogs();
            showNotification('Dados atualizados!', 'info');
        }

        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification fixed top-4 right-4 p-4 rounded shadow-lg z-50 ${getNotificationClass(type)}`;
            notification.innerHTML = `
                <div class="flex items-center">
                    <i class="fas ${getNotificationIcon(type)} mr-2"></i>
                    ${message}
                    <button onclick="this.closest('.notification').remove()" class="ml-4 hover:opacity-75">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.remove();
                }
            }, 5000);
        }

        function getNotificationClass(type) {
            switch(type) {
                case 'success': return 'bg-green-500 text-white';
                case 'error': return 'bg-red-500 text-white';
                case 'warning': return 'bg-yellow-500 text-white';
                default: return 'bg-blue-500 text-white';
            }
        }

        function getNotificationIcon(type) {
            switch(type) {
                case 'success': return 'fa-check-circle';
                case 'error': return 'fa-exclamation-circle';
                case 'warning': return 'fa-exclamation-triangle';
                default: return 'fa-info-circle';
            }
        }

        // Inicializar quando a p√°gina carregar
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(initTest, 1500); // Aguardar carregamento dos scripts
        });

        // Atualizar dados periodicamente
        setInterval(refreshAll, 30000); // A cada 30 segundos
    </script>
</body>
</html>