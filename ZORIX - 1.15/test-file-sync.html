<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste - Sistema de Sincroniza√ß√£o de Arquivos</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .notification { transition: all 0.3s ease; }
    </style>
</head>
<body class="bg-gray-100">
    <div class="container mx-auto px-4 py-8">
        <h1 class="text-3xl font-bold text-gray-800 mb-8">üîÑ Teste - Sistema de Sincroniza√ß√£o de Arquivos</h1>
        
        <!-- Status do Sistema -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-8">
            <h2 class="text-xl font-semibold mb-4">üìä Status do Sistema</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="bg-blue-50 p-4 rounded">
                    <div class="text-blue-600 font-semibold">Clientes Cadastrados</div>
                    <div id="clientesCount" class="text-2xl font-bold">0</div>
                </div>
                <div class="bg-green-50 p-4 rounded">
                    <div class="text-green-600 font-semibold">Arquivos Cliente</div>
                    <div id="arquivosClienteCount" class="text-2xl font-bold">0</div>
                </div>
                <div class="bg-purple-50 p-4 rounded">
                    <div class="text-purple-600 font-semibold">Arquivos Sistema</div>
                    <div id="arquivosSistemaCount" class="text-2xl font-bold">0</div>
                </div>
            </div>
        </div>

        <!-- Simula√ß√£o de Upload de Cliente -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-8">
            <h2 class="text-xl font-semibold mb-4">üìÅ Simula√ß√£o de Upload por Cliente</h2>
            
            <!-- Seletor de Cliente -->
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">Cliente:</label>
                <select id="clienteSelect" class="w-full p-2 border rounded">
                    <option value="">Selecione um cliente...</option>
                </select>
            </div>

            <!-- Upload de Arquivo -->
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">Selecionar Arquivo:</label>
                <input type="file" id="testFileInput" multiple class="w-full p-2 border rounded">
            </div>

            <div class="flex gap-4">
                <button onclick="simularUpload()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded">
                    <i class="fas fa-upload mr-2"></i>Simular Upload
                </button>
                <button onclick="sincronizarArquivos()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded">
                    <i class="fas fa-sync-alt mr-2"></i>Sincronizar
                </button>
            </div>
        </div>

        <!-- Lista de Arquivos por Cliente -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-8">
            <h2 class="text-xl font-semibold mb-4">üìã Arquivos do Cliente Selecionado</h2>
            <div id="arquivosClienteLista" class="space-y-2">
                <p class="text-gray-500">Selecione um cliente para ver seus arquivos</p>
            </div>
        </div>

        <!-- Lista de Arquivos do Sistema -->
        <div class="bg-white rounded-lg shadow-md p-6">
            <h2 class="text-xl font-semibold mb-4">üóÇÔ∏è Arquivos no Sistema Principal</h2>
            <div id="arquivosSistemaLista" class="space-y-2">
                <p class="text-gray-500">Nenhum arquivo sincronizado</p>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="js/storage.js"></script>
    <script src="js/zorix-storage.js"></script>
    <script src="js/api.js"></script>
    <script src="js/clientes-v5.js"></script>

    <script>
        let currentClienteId = null;

        // Inicializar sistema de teste
        async function initTest() {
            console.log('üöÄ Inicializando teste do sistema de sincroniza√ß√£o...');
            
            try {
                // Aguardar carregamento dos sistemas
                await new Promise(resolve => setTimeout(resolve, 500));
                
                // Carregar lista de clientes
                loadClientes();
                
                // Atualizar contadores
                updateCounts();
                
                // Listener para mudan√ßa de cliente
                document.getElementById('clienteSelect').addEventListener('change', function(e) {
                    currentClienteId = e.target.value;
                    if (currentClienteId) {
                        loadArquivosCliente(currentClienteId);
                    } else {
                        document.getElementById('arquivosClienteLista').innerHTML = '<p class="text-gray-500">Selecione um cliente para ver seus arquivos</p>';
                    }
                });

                console.log('‚úÖ Sistema de teste inicializado com sucesso');
            } catch (error) {
                console.error('‚ùå Erro ao inicializar teste:', error);
                showNotification('Erro ao inicializar sistema de teste', 'error');
            }
        }

        function loadClientes() {
            try {
                const clientes = window.zorixStorage ? window.zorixStorage.listClientes() : [];
                const select = document.getElementById('clienteSelect');
                
                select.innerHTML = '<option value="">Selecione um cliente...</option>';
                
                clientes.forEach(cliente => {
                    const option = document.createElement('option');
                    option.value = cliente.id;
                    option.textContent = cliente.nome;
                    select.appendChild(option);
                });

                console.log(`üìã ${clientes.length} clientes carregados`);
            } catch (error) {
                console.error('‚ùå Erro ao carregar clientes:', error);
            }
        }

        function loadArquivosCliente(clienteId) {
            try {
                const arquivos = JSON.parse(localStorage.getItem(`zorix:arquivos_${clienteId}`) || '[]');
                const container = document.getElementById('arquivosClienteLista');
                
                if (arquivos.length === 0) {
                    container.innerHTML = '<p class="text-gray-500">Nenhum arquivo encontrado para este cliente</p>';
                    return;
                }

                container.innerHTML = arquivos.map(arquivo => `
                    <div class="flex items-center justify-between p-3 border rounded bg-gray-50">
                        <div class="flex items-center space-x-3">
                            <i class="fas fa-file text-blue-500"></i>
                            <div>
                                <div class="font-medium">${arquivo.nome}</div>
                                <div class="text-sm text-gray-500">
                                    ${formatFileSize(arquivo.tamanho)} ‚Ä¢ ${new Date(arquivo.dataUpload).toLocaleString()}
                                </div>
                            </div>
                        </div>
                        <div class="flex space-x-2">
                            <button onclick="downloadArquivoCliente('${clienteId}', '${arquivo.id}')" 
                                class="text-green-600 hover:text-green-800" title="Download">
                                <i class="fas fa-download"></i>
                            </button>
                            <button onclick="removerArquivoCliente('${clienteId}', '${arquivo.id}')" 
                                class="text-red-600 hover:text-red-800" title="Remover">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `).join('');

                console.log(`üìÑ ${arquivos.length} arquivos carregados para o cliente`);
            } catch (error) {
                console.error('‚ùå Erro ao carregar arquivos do cliente:', error);
            }
        }

        async function simularUpload() {
            if (!currentClienteId) {
                showNotification('Selecione um cliente primeiro', 'error');
                return;
            }

            const fileInput = document.getElementById('testFileInput');
            if (fileInput.files.length === 0) {
                showNotification('Selecione pelo menos um arquivo', 'error');
                return;
            }

            try {
                // Simular upload usando a fun√ß√£o do sistema
                const event = { target: fileInput };
                await window.clientesV5.handleFileUpload(event, currentClienteId);
                
                // Recarregar listas
                loadArquivosCliente(currentClienteId);
                loadArquivosSistema();
                updateCounts();
                
                // Limpar input
                fileInput.value = '';
                
                showNotification('Upload simulado com sucesso!', 'success');
            } catch (error) {
                console.error('‚ùå Erro no upload simulado:', error);
                showNotification('Erro no upload simulado', 'error');
            }
        }

        async function sincronizarArquivos() {
            if (!currentClienteId) {
                showNotification('Selecione um cliente primeiro', 'error');
                return;
            }

            try {
                await window.clientesV5.sincronizarArquivos(currentClienteId);
                
                // Recarregar listas
                loadArquivosSistema();
                updateCounts();
                
                showNotification('Sincroniza√ß√£o conclu√≠da!', 'success');
            } catch (error) {
                console.error('‚ùå Erro na sincroniza√ß√£o:', error);
                showNotification('Erro na sincroniza√ß√£o', 'error');
            }
        }

        function loadArquivosSistema() {
            try {
                // Buscar arquivos do sistema atrav√©s da API
                let arquivos = [];
                
                if (window.api && window.api.listArquivos) {
                    arquivos = window.api.listArquivos() || [];
                } else if (window.storage) {
                    arquivos = window.storage.getItem('arquivos') || [];
                }
                
                const container = document.getElementById('arquivosSistemaLista');
                
                if (arquivos.length === 0) {
                    container.innerHTML = '<p class="text-gray-500">Nenhum arquivo sincronizado</p>';
                    return;
                }

                container.innerHTML = arquivos.map(arquivo => `
                    <div class="flex items-center justify-between p-3 border rounded bg-gray-50">
                        <div class="flex items-center space-x-3">
                            <i class="fas fa-file text-purple-500"></i>
                            <div>
                                <div class="font-medium">${arquivo.nome_arquivo || arquivo.nome}</div>
                                <div class="text-sm text-gray-500">
                                    Cliente: ${arquivo.cliente_nome || 'N/A'} ‚Ä¢ 
                                    ${formatFileSize(arquivo.tamanho)} ‚Ä¢ 
                                    ${new Date(arquivo.data_upload || arquivo.dataUpload).toLocaleString()}
                                </div>
                            </div>
                        </div>
                        <div class="flex space-x-2">
                            <button onclick="downloadArquivoSistema('${arquivo.id}')" 
                                class="text-green-600 hover:text-green-800" title="Download">
                                <i class="fas fa-download"></i>
                            </button>
                        </div>
                    </div>
                `).join('');

                console.log(`üóÇÔ∏è ${arquivos.length} arquivos carregados do sistema`);
            } catch (error) {
                console.error('‚ùå Erro ao carregar arquivos do sistema:', error);
            }
        }

        function downloadArquivoCliente(clienteId, arquivoId) {
            try {
                const arquivos = JSON.parse(localStorage.getItem(`zorix:arquivos_${clienteId}`) || '[]');
                const arquivo = arquivos.find(a => a.id === arquivoId);
                
                if (!arquivo || !arquivo.conteudo_base64) {
                    showNotification('Arquivo n√£o encontrado ou sem conte√∫do', 'error');
                    return;
                }

                // Converter base64 para download
                const byteCharacters = atob(arquivo.conteudo_base64);
                const byteNumbers = new Array(byteCharacters.length);
                for (let i = 0; i < byteCharacters.length; i++) {
                    byteNumbers[i] = byteCharacters.charCodeAt(i);
                }
                const byteArray = new Uint8Array(byteNumbers);
                const blob = new Blob([byteArray], { type: arquivo.tipo });
                
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = arquivo.nome;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                showNotification(`Download de "${arquivo.nome}" conclu√≠do!`, 'success');
            } catch (error) {
                console.error('‚ùå Erro no download:', error);
                showNotification('Erro no download do arquivo', 'error');
            }
        }

        function downloadArquivoSistema(arquivoId) {
            try {
                if (window.arquivosManager && window.arquivosManager.downloadFile) {
                    window.arquivosManager.downloadFile(arquivoId);
                } else {
                    showNotification('Sistema de arquivos n√£o dispon√≠vel', 'error');
                }
            } catch (error) {
                console.error('‚ùå Erro no download do sistema:', error);
                showNotification('Erro no download do sistema', 'error');
            }
        }

        function removerArquivoCliente(clienteId, arquivoId) {
            if (!confirm('Tem certeza que deseja remover este arquivo?')) return;

            try {
                const arquivos = JSON.parse(localStorage.getItem(`zorix:arquivos_${clienteId}`) || '[]');
                const novosArquivos = arquivos.filter(a => a.id !== arquivoId);
                
                localStorage.setItem(`zorix:arquivos_${clienteId}`, JSON.stringify(novosArquivos));
                
                loadArquivosCliente(clienteId);
                updateCounts();
                
                showNotification('Arquivo removido com sucesso!', 'success');
            } catch (error) {
                console.error('‚ùå Erro ao remover arquivo:', error);
                showNotification('Erro ao remover arquivo', 'error');
            }
        }

        function updateCounts() {
            try {
                // Contar clientes
                const clientes = window.zorixStorage ? window.zorixStorage.listClientes() : [];
                document.getElementById('clientesCount').textContent = clientes.length;

                // Contar arquivos de clientes
                let totalArquivosCliente = 0;
                clientes.forEach(cliente => {
                    const arquivos = JSON.parse(localStorage.getItem(`zorix:arquivos_${cliente.id}`) || '[]');
                    totalArquivosCliente += arquivos.length;
                });
                document.getElementById('arquivosClienteCount').textContent = totalArquivosCliente;

                // Contar arquivos do sistema
                let arquivosSistema = [];
                if (window.api && window.api.listArquivos) {
                    arquivosSistema = window.api.listArquivos() || [];
                } else if (window.storage) {
                    arquivosSistema = window.storage.getItem('arquivos') || [];
                }
                document.getElementById('arquivosSistemaCount').textContent = arquivosSistema.length;

            } catch (error) {
                console.error('‚ùå Erro ao atualizar contadores:', error);
            }
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification fixed top-4 right-4 p-4 rounded shadow-lg z-50 ${getNotificationClass(type)}`;
            notification.innerHTML = `
                <div class="flex items-center">
                    <i class="fas ${getNotificationIcon(type)} mr-2"></i>
                    ${message}
                </div>
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 5000);
        }

        function getNotificationClass(type) {
            switch(type) {
                case 'success': return 'bg-green-500 text-white';
                case 'error': return 'bg-red-500 text-white';
                case 'warning': return 'bg-yellow-500 text-white';
                default: return 'bg-blue-500 text-white';
            }
        }

        function getNotificationIcon(type) {
            switch(type) {
                case 'success': return 'fa-check-circle';
                case 'error': return 'fa-exclamation-circle';
                case 'warning': return 'fa-exclamation-triangle';
                default: return 'fa-info-circle';
            }
        }

        // Inicializar quando a p√°gina carregar
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(initTest, 1000); // Aguardar carregamento dos scripts
        });

        // Atualizar listas periodicamente
        setInterval(() => {
            if (currentClienteId) {
                loadArquivosCliente(currentClienteId);
            }
            loadArquivosSistema();
            updateCounts();
        }, 30000); // A cada 30 segundos
    </script>
</body>
</html>